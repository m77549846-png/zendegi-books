<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>کتاب‌خوان جهانی مدرن - اشتراک‌گذاری دانش با ملل مختلف</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    @font-face {
      font-family: 'Vazir';
      src: url('fonts/Vazir-Regular.woff2') format('woff2');
      font-weight: 400;
      font-style: normal;
    }
    
    :root {
      --primary-color: #007bff;
      --secondary-color: #f8f9fa;
      --text-color: #333;
      --bg-color: #ffffff;
      --accent-color: #28a745;
      --header-bg: linear-gradient(135deg, #007bff, #28a745);
      --shadow: 0 4px 12px rgba(0,0,0,0.15);
      --border-radius: 8px;
    }
    
    body {
      margin: 0;
      font-family: 'Vazir', sans-serif;
      direction: rtl;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    
    body.dark-mode {
      --secondary-color: #343a40;
      --text-color: #f8f9fa;
      --bg-color: #212529;
    }
    
    .top-bar {
      background: var(--header-bg);
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .user-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: var(--border-radius);
      border: none;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background-color: var(--accent-color);
      color: white;
    }
    
    .btn-outline {
      background-color: transparent;
      border: 1px solid white;
      color: white;
    }
    
    .main-container {
      display: flex;
      flex: 1;
    }
    
    .sidebar {
      width: 280px;
      background-color: var(--secondary-color);
      padding: 20px;
      border-left: 1px solid #ddd;
      overflow-y: auto;
    }
    
    .sidebar-section {
      margin-bottom: 25px;
    }
    
    .sidebar-section h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--primary-color);
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
    }
    
    .book-list, .chapter-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .book-item, .chapter-item {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .book-item:hover, .chapter-item:hover {
      background-color: rgba(0, 123, 255, 0.1);
    }
    
    .book-item.active, .chapter-item.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    
    .reader-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    
    .book-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .reader-controls {
      display: flex;
      gap: 10px;
    }
    
    .text-display {
      flex: 1;
      padding: 25px;
      line-height: 2;
      font-size: 1.1rem;
      background-color: var(--bg-color);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow-y: auto;
    }
    
    .notes-section {
      margin-top: 20px;
      padding: 15px;
      background-color: var(--secondary-color);
      border-radius: var(--border-radius);
    }
    
    .notes-section h3 {
      margin-top: 0;
      color: var(--primary-color);
    }
    
    .note-item {
      background: white;
      padding: 10px;
      margin: 10px 0;
      border-radius: var(--border-radius);
      border-right: 4px solid var(--accent-color);
    }
    
    footer {
      background-color: var(--secondary-color);
      padding: 20px;
      text-align: center;
      border-top: 1px solid #ddd;
    }
    
    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: nowrap;
    }
    
    .footer-section {
      flex: 1;
      min-width: 250px;
    }
    
    .footer-section h4 {
      margin-top: 0;
      color: var(--primary-color);
    }
    
    .footer-links {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    
    .social-links {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        border-left: none;
        border-bottom: 1px solid #ddd;
      }
      
      .footer-content {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="logo">
      <i class="fas fa-book-open"></i>
      <span>کتاب‌خوان جهانی</span>
    </div>
    
    <div class="user-actions">
      <select id="langSelect" class="btn btn-outline">
        <option value="fa">فارسی</option>
        <option value="en">English</option>
        <option value="es">Español</option>
        <option value="zh">中文</option>
        <option value="hi">हिन्दी</option>
        <option value="ar">العربية</option>
        <option value="fr">Français</option>
        <option value="de">Deutsch</option>
      </select>
      <button class="btn btn-outline" id="themeToggle">
        <i class="fas fa-moon"></i> تم تاریک
      </button>
      <button class="btn btn-primary" id="loginBtn">
        <i class="fas fa-user"></i> ورود / ثبت‌نام
      </button>
    </div>
  </div>
  
  <div class="main-container">
    <div class="sidebar">
      <div class="sidebar-section">
        <h3><i class="fas fa-books"></i> کتاب‌ها</h3>
        <input type="text" id="bookSearch" placeholder="جستجو در کتاب‌ها..." style="width: 100%; padding: 8px; margin-bottom: 15px; border-radius: var(--border-radius); border: 1px solid #ddd;">
        <div id="bookAccordion"></div>
      </div>
      
      <div class="sidebar-section">
        <h3><i class="fas fa-plus"></i> افزودن/ویرایش کتاب</h3>
        <input type="text" id="newBookTitle" placeholder="عنوان کتاب" required>
        <input type="text" id="newBookAuthor" placeholder="نویسنده" required>
        <input type="text" id="newBookLink" placeholder="لینک کتاب (اختیاری)">
        <input type="text" id="newChapterTitle" placeholder="عنوان فصل/مقدمه/...">
        <select id="contentType">
          <option value="chapter">فصل</option>
          <option value="introduction">مقدمه</option>
          <option value="conclusion">جمع‌بندی</option>
          <option value="appendix">پیوست</option>
        </select>
        <textarea id="newTextFa" placeholder="متن فارسی"></textarea>
        <textarea id="newTextEn" placeholder="متن انگلیسی"></textarea>
        <textarea id="newTextEs" placeholder="متن اسپانیایی"></textarea>
        <textarea id="newTextZh" placeholder="متن چینی"></textarea>
        <textarea id="newTextHi" placeholder="متن هندی"></textarea>
        <textarea id="newTextAr" placeholder="متن عربی"></textarea>
        <textarea id="newTextFr" placeholder="متن فرانسوی"></textarea>
        <textarea id="newTextDe" placeholder="متن آلمانی"></textarea>
        <input type="file" id="pdfUpload" accept=".pdf">
        <input type="file" id="epubUpload" accept=".epub">
        <input type="text" id="resources" placeholder="منابع (با ; جدا کنید)">
        <input type="text" id="tocEntries" placeholder="فهرست: عنوان,صفحه;عنوان,صفحه">
        <button class="btn btn-primary" onclick="addNewContent()">ذخیره</button>
        <button class="btn btn-outline" onclick="exportBooks()">اکسپورت JSON</button>
        <button class="btn btn-outline" onclick="importBooks()">ایمپورت JSON</button>
      </div>
      
      <div class="sidebar-section">
        <h3><i class="fas fa-list-ul"></i> فهرست کتاب</h3>
        <input type="text" id="chapterSearch" placeholder="جستجو در فصل‌ها..." style="width: 100%; padding: 8px; margin-bottom: 15px; border-radius: var(--border-radius); border: 1px solid #ddd;">
        <ul class="chapter-list" id="chapterList"></ul>
      </div>
      
      <div class="sidebar-section">
        <h3><i class="fas fa-chart-line"></i> آمار</h3>
        <div style="background: white; padding: 15px; border-radius: var(--border-radius);">
          <p>تعداد کتاب‌ها: <strong id="booksCount">0</strong></p>
          <p>تعداد زبان‌ها: <strong>8</strong></p>
          <p>تعداد کاربران: <strong id="usersCount">0</strong></p>
        </div>
      </div>
    </div>
    
    <div class="content-area">
      <div class="reader-header">
        <div class="book-title" id="currentBookTitle">لطفاً یک کتاب انتخاب کنید</div>
        <div class="reader-controls">
          <button class="btn btn-primary" id="addNoteBtn">
            <i class="fas fa-sticky-note"></i> افزودن یادداشت
          </button>
          <button class="btn btn-outline" id="shareBtn">
            <i class="fas fa-share-alt"></i> اشتراک‌گذاری
          </button>
        </div>
      </div>
      
      <div class="text-display" id="textDisplay">
        <div style="text-align: center; padding: 50px; color: #666;">
          <i class="fas fa-book-open" style="font-size: 3rem; margin-bottom: 20px;"></i>
          <h3>به کتابخوان جهانی خوش آمدید</h3>
          <p>برای شروع مطالعه، لطفاً یک کتاب از لیست سمت چپ انتخاب کنید.</p>
        </div>
      </div>
      
      <iframe id="pdfViewer" style="display: none; width: 100%; height: 600px; border: none; margin-top: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow);"></iframe>
      <div id="epubViewer" style="display: none; width: 100%; height: 600px; margin-top: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow);"></div>
      
      <div class="notes-section">
        <h3><i class="fas fa-sticky-note"></i> یادداشت‌های من</h3>
        <div id="notesList">
          <p style="text-align: center; color: #666;">هیچ یادداشتی وجود ندارد. برای افزودن یادداشت، بخشی از متن را انتخاب و روی دکمه "افزودن یادداشت" کلیک کنید.</p>
        </div>
      </div>
    </div>
  </div>
  
  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h4>درباره ما</h4>
        <p>کتابخوان جهانی پلتفرمی است برای اشتراک‌گذاری دانش به صورت رایگان با تمام ملل جهان. ما معتقدیم دانش باید برای همه در دسترس باشد.</p>
      </div>
      
      <div class="footer-section">
        <h4>لینک‌های مفید</h4>
        <div class="footer-links">
          <a href="#" style="color: var(--primary-color); text-decoration: none;">صفحه اصلی</a>
          <span>/</span>
          <a href="#" style="color: var(--primary-color); text-decoration: none;">کتاب‌ها</a>
          <span>/</span>
          <a href="#" style="color: var(--primary-color); text-decoration: none;">درباره ما</a>
          <span>/</span>
          <a href="#" style="color: var(--primary-color); text-decoration: none;">تماس با ما</a>
        </div>
      </div>
      
      <div class="footer-section">
        <h4>تماس با ما</h4>
        <p>ایمیل: info@globalreader.org</p>
        <div class="social-links">
          <a href="#" style="color: var(--primary-color);"><i class="fab fa-instagram"></i></a>
          <a href="#" style="color: var(--primary-color);"><i class="fab fa-whatsapp"></i></a>
          <a href="#" style="color: var(--primary-color);"><i class="fab fa-linkedin"></i></a>
          <a href="#" style="color: var(--primary-color);"><i class="fab fa-youtube"></i></a>
        </div>
      </div>
    </div>
    
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
      © ۱۴۰۴ کتاب‌خوان جهانی | طراحی‌شده با ❤️ برای تمام ملل جهان
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>

  <script>
    let books = [];
    let notes = [];
    let selectedBook = null;
    let selectedChapter = null;
    let currentLang = "fa";
    let epubBook = null;
    let db = null;

    const bookAccordion = document.getElementById("bookAccordion");
    const chapterList = document.getElementById("chapterList");
    const textDisplay = document.getElementById("textDisplay");
    const pdfViewer = document.getElementById("pdfViewer");
    const epubViewer = document.getElementById("epubViewer");
    const langSelect = document.getElementById("langSelect");
    const bookSearch = document.getElementById("bookSearch");
    const chapterSearch = document.getElementById("chapterSearch");
    const notesList = document.getElementById("notesList");
    const currentBookTitle = document.getElementById("currentBookTitle");
    const booksCount = document.getElementById("booksCount");
    const themeToggle = document.getElementById("themeToggle");
    const addNoteBtn = document.getElementById("addNoteBtn");
    const shareBtn = document.getElementById("shareBtn");
    const loginBtn = document.getElementById("loginBtn");

    // Initialize IndexedDB
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('GlobalReaderDB', 1);
        
        request.onupgradeneeded = (event) => {
          db = event.target.result;
          db.createObjectStore('books', { keyPath: 'id', autoIncrement: true });
          db.createObjectStore('notes', { keyPath: 'id', autoIncrement: true });
        };
        
        request.onsuccess = (event) => {
          db = event.target.result;
          resolve();
        };
        
        request.onerror = (event) => {
          reject('خطا در باز کردن پایگاه داده: ' + event.target.errorCode);
        };
      });
    }

    // Load books and notes from IndexedDB
    async function loadData() {
      try {
        const booksTx = db.transaction(['books'], 'readonly');
        const booksStore = booksTx.objectStore('books');
        const booksRequest = booksStore.getAll();
        
        booksRequest.onsuccess = () => {
          books = booksRequest.result;
          renderBookAccordion();
        };
        
        const notesTx = db.transaction(['notes'], 'readonly');
        const notesStore = notesTx.objectStore('notes');
        const notesRequest = notesStore.getAll();
        
        notesRequest.onsuccess = () => {
          notes = notesRequest.result;
          renderNotesList();
        };
      } catch (err) {
        console.error('خطا در بارگذاری داده‌ها:', err);
      }
    }

    function init() {
      initDB().then(() => {
        loadData();
        updateStats();
        
        langSelect.onchange = () => {
          currentLang = langSelect.value;
          if (selectedBook && selectedChapter) updateTextDisplay();
        };
        bookSearch.oninput = () => filterList(bookAccordion, bookSearch.value, true);
        chapterSearch.oninput = () => filterList(chapterList, chapterSearch.value, false);
        themeToggle.addEventListener('click', toggleTheme);
        addNoteBtn.addEventListener('click', addNoteFromSelection);
        shareBtn.addEventListener('click', shareBook);
        loginBtn.addEventListener('click', showLoginModal);
      }).catch(err => {
        alert(err);
      });
    }

    function filterList(container, query, isAccordion) {
      if (isAccordion) {
        Array.from(container.children).forEach(details => {
          const title = details.querySelector('summary').textContent;
          details.style.display = title.toLowerCase().includes(query.toLowerCase()) ? '' : 'none';
        });
      } else {
        Array.from(container.children).forEach(li => {
          li.style.display = li.textContent.toLowerCase().includes(query.toLowerCase()) ? '' : 'none';
        });
      }
    }

    function renderBookAccordion() {
      bookAccordion.innerHTML = "";
      books.forEach(book => {
        const details = document.createElement("details");
        const summary = document.createElement("summary");
        summary.textContent = `${book.title} (${book.author})`;
        details.appendChild(summary);
        const ul = document.createElement("ul");
        if (Object.keys(book.introduction).length > 0) {
          const li = document.createElement("li");
          li.textContent = "مقدمه";
          li.onclick = () => selectChapter(book.title, "introduction");
          ul.appendChild(li);
        }
        book.chapters.forEach(ch => {
          const li = document.createElement("li");
          li.textContent = ch.title;
          li.onclick = () => selectChapter(book.title, ch.title);
          ul.appendChild(li);
        });
        if (Object.keys(book.conclusion).length > 0) {
          const li = document.createElement("li");
          li.textContent = "جمع‌بندی";
          li.onclick = () => selectChapter(book.title, "conclusion");
          ul.appendChild(li);
        }
        book.appendices.forEach(app => {
          const li = document.createElement("li");
          li.textContent = app.title;
          li.onclick = () => selectChapter(book.title, app.title);
          ul.appendChild(li);
        });
        details.appendChild(ul);
        bookAccordion.appendChild(details);
      });
      updateStats();
    }

    function selectChapter(bookTitle, chapterTitle) {
      selectedBook = bookTitle;
      selectedChapter = chapterTitle;
      currentBookTitle.textContent = bookTitle;
      updateChapterListUI();
      updateTextDisplay();
      renderNotesList();
    }

    function updateChapterListUI() {
      chapterList.innerHTML = "";
      const book = books.find(b => b.title === selectedBook);
      if (!book) return;
      book.toc.forEach(toc => {
        const li = document.createElement("li");
        li.className = "chapter-item";
        li.textContent = `${toc.title} (صفحه ${toc.page})`;
        li.onclick = () => {
          selectedChapter = toc.title;
          updateTextDisplay();
          renderNotesList();
          highlightChapter(li);
        };
        chapterList.appendChild(li);
      });
    }

    function highlightChapter(selectedLi) {
      Array.from(chapterList.children).forEach(li => li.classList.remove("active"));
      selectedLi.classList.add("active");
    }

    function updateTextDisplay() {
      const book = books.find(b => b.title === selectedBook);
      if (!book || !selectedChapter) return;

      let content = "", resources = [], isAppendix = false;
      if (selectedChapter === "مقدمه") {
        content = book.introduction[currentLang] || "متنی برای این زبان موجود نیست.";
      } else if (selectedChapter === "جمع‌بندی") {
        content = book.conclusion[currentLang] || "متنی برای این زبان موجود نیست.";
      } else if (book.appendices.some(a => a.title === selectedChapter)) {
        const app = book.appendices.find(a => a.title === selectedChapter);
        content = app.content[currentLang] || "متنی برای این زبان موجود نیست.";
        isAppendix = true;
      } else {
        const ch = book.chapters.find(c => c.title === selectedChapter);
        if (ch) {
          content = ch.content[currentLang] || "متنی برای این زبان موجود نیست.";
          resources = ch.resources || [];
        }
      }

      textDisplay.innerHTML = `<div>${content}</div>`;
      if (resources.length) {
        textDisplay.innerHTML += `<h3>منابع</h3><ul>${resources.map(r => `<li>${r}</li>`).join('')}</ul>`;
      }
      pdfViewer.style.display = "none";
      epubViewer.style.display = "none";
      if (epubBook) epubBook.destroy();

      if (book.pdf) {
        pdfViewer.src = book.pdf;
        pdfViewer.style.display = "block";
      } else if (book.epub) {
        loadEpub(book.epub);
      } else if (book.link) {
        pdfViewer.src = book.link;
        pdfViewer.style.display = "block";
      }
    }

    async function addNewContent() {
      const title = document.getElementById("newBookTitle").value.trim();
      const author = document.getElementById("newBookAuthor").value.trim();
      const link = document.getElementById("newBookLink").value.trim();
      const contentTitle = document.getElementById("newChapterTitle").value.trim();
      const contentType = document.getElementById("contentType").value;
      const fa = document.getElementById("newTextFa").value.trim();
      const en = document.getElementById("newTextEn").value.trim();
      const es = document.getElementById("newTextEs").value.trim();
      const zh = document.getElementById("newTextZh").value.trim();
      const hi = document.getElementById("newTextHi").value.trim();
      const ar = document.getElementById("newTextAr").value.trim();
      const fr = document.getElementById("newTextFr").value.trim();
      const de = document.getElementById("newTextDe").value.trim();
      const resources = document.getElementById("resources").value.split(';').map(r => r.trim()).filter(r => r);
      const tocEntries = document.getElementById("tocEntries").value.split(';').map(t => {
        const [title, page] = t.split(',').map(s => s.trim());
        return { title, page: parseInt(page) || 0 };
      }).filter(t => t.title && t.page);

      const pdfFile = document.getElementById("pdfUpload").files[0];
      const epubFile = document.getElementById("epubUpload").files[0];

      let pdf = "", epub = "";
      if (pdfFile) {
        const reader = new FileReader();
        pdf = await new Promise(r => { reader.onload = () => r(reader.result); reader.readAsDataURL(pdfFile); });
      }
      if (epubFile) {
        const reader = new FileReader();
        epub = await new Promise(r => { reader.onload = () => r(reader.result); reader.readAsDataURL(epubFile); });
      }

      if (!title || !author || (!contentTitle && !["introduction", "conclusion"].includes(contentType))) {
        alert("عنوان کتاب، نویسنده و محتوا را وارد کنید.");
        return;
      }

      let book = books.find(b => b.title === title);
      if (!book) {
        book = { title, author, link, pdf, epub, introduction: {}, chapters: [], conclusion: {}, appendices: [], toc: [] };
      } else {
        if (link) book.link = link;
        if (pdf) book.pdf = pdf;
        if (epub) book.epub = epub;
      }

      const contentObj = { fa, en, es, zh, hi, ar, fr, de };
      if (contentType === "introduction") book.introduction = contentObj;
      else if (contentType === "conclusion") book.conclusion = contentObj;
      else if (contentType === "appendix") book.appendices.push({ title: contentTitle, content: contentObj });
      else book.chapters.push({ title: contentTitle, content: contentObj, resources });

      if (tocEntries.length) {
        book.toc = tocEntries;
      }

      // Save to IndexedDB
      const tx = db.transaction(['books'], 'readwrite');
      const store = tx.objectStore('books');
      if (book.id) {
        store.put(book);
      } else {
        store.add(book);
      }
      tx.oncomplete = () => {
        books = books.filter(b => b.title !== book.title);
        books.push(book);
        renderBookAccordion();
        clearForm();
        alert("محتوا ذخیره شد.");
      };
      tx.onerror = () => {
        alert("خطا در ذخیره‌سازی کتاب.");
      };
    }

    function loadEpub(epubDataUrl) {
      epubViewer.style.display = "block";
      epubBook = ePub(epubDataUrl);
      const rendition = epubBook.renderTo("epubViewer", { width: "100%", height: 600 });
      rendition.display();
    }

    function addNoteFromSelection() {
      if (!selectedBook || !selectedChapter) {
        alert("ابتدا یک فصل را انتخاب کنید.");
        return;
      }
      const selection = window.getSelection().toString().trim();
      if (!selection) {
        alert("لطفاً بخشی از متن را انتخاب کنید.");
        return;
      }
      const noteText = prompt("یادداشت خود را وارد کنید:", "");
      if (noteText === null) return;
      const note = {
        book: selectedBook,
        chapter: selectedChapter,
        selectedText: selection,
        note: noteText,
        date: new Date().toISOString()
      };

      const tx = db.transaction(['notes'], 'readwrite');
      const store = tx.objectStore('notes');
      store.add(note);
      tx.oncomplete = () => {
        notes.push(note);
        renderNotesList();
        alert("یادداشت ذخیره شد.");
      };
      tx.onerror = () => {
        alert("خطا در ذخیره‌سازی یادداشت.");
      };
    }

    function renderNotesList() {
      notesList.innerHTML = "";
      const bookNotes = notes.filter(n => n.book === selectedBook && n.chapter === selectedChapter);
      if (bookNotes.length === 0) {
        notesList.innerHTML = "<p style='text-align: center; color: #666;'>هیچ یادداشتی وجود ندارد.</p>";
        return;
      }
      bookNotes.forEach((note, i) => {
        const div = document.createElement("div");
        div.className = "note-item";
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
              <div style="font-weight: bold; margin-bottom: 5px;">«${note.selectedText.substring(0, 30)}...»</div>
              <div>${note.note}</div>
              <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">${new Date(note.date).toLocaleDateString('fa-IR')}</div>
            </div>
            <button class="btn" onclick="deleteNote(${i})" style="background: none; border: none; color: #dc3545; cursor: pointer;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        notesList.appendChild(div);
      });
    }

    function deleteNote(localIndex) {
      const bookNotes = notes.filter(n => n.book === selectedBook && n.chapter === selectedChapter);
      const note = bookNotes[localIndex];
      if (!note || !note.id) return;

      const tx = db.transaction(['notes'], 'readwrite');
      const store = tx.objectStore('notes');
      store.delete(note.id);
      tx.oncomplete = () => {
        notes = notes.filter(n => n !== note);
        renderNotesList();
      };
      tx.onerror = () => {
        alert("خطا در حذف یادداشت.");
      };
    }

    function exportBooks() {
      const dataStr = JSON.stringify({ books }, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'books_export.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importBooks() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async ev => {
          try {
            const data = JSON.parse(ev.target.result);
            if (Array.isArray(data.books)) {
              const tx = db.transaction(['books'], 'readwrite');
              const store = tx.objectStore('books');
              store.clear();
              data.books.forEach(book => store.add(book));
              tx.oncomplete = () => {
                books = data.books;
                renderBookAccordion();
                alert("کتاب‌ها ایمپورت شدند.");
              };
              tx.onerror = () => {
                alert("خطا در ایمپورت کتاب‌ها.");
              };
            }
          } catch (err) {
            alert("خطا در خواندن فایل: " + err.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function clearForm() {
      document.getElementById("newBookTitle").value = "";
      document.getElementById("newBookAuthor").value = "";
      document.getElementById("newBookLink").value = "";
      document.getElementById("newChapterTitle").value = "";
      document.getElementById("newTextFa").value = "";
      document.getElementById("newTextEn").value = "";
      document.getElementById("newTextEs").value = "";
      document.getElementById("newTextZh").value = "";
      document.getElementById("newTextHi").value = "";
      document.getElementById("newTextAr").value = "";
      document.getElementById("newTextFr").value = "";
      document.getElementById("newTextDe").value = "";
      document.getElementById("resources").value = "";
      document.getElementById("pdfUpload").value = "";
      document.getElementById("epubUpload").value = "";
      document.getElementById("tocEntries").value = "";
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      themeToggle.innerHTML = document.body.classList.contains('dark-mode') 
        ? '<i class="fas fa-sun"></i> تم روشن' 
        : '<i class="fas fa-moon"></i> تم تاریک';
    }

    function shareBook() {
      if (!selectedBook || !selectedChapter) {
        alert('لطفاً ابتدا یک کتاب و فصل انتخاب کنید.');
        return;
      }
      
      const shareUrl = `${window.location.origin}?book=${encodeURIComponent(selectedBook)}&chapter=${encodeURIComponent(selectedChapter)}`;
      
      if (navigator.share) {
        navigator.share({
          title: selectedBook,
          text: `خواندن «${selectedChapter}» از کتاب «${selectedBook}»`,
          url: shareUrl
        });
      } else {
        navigator.clipboard.writeText(shareUrl).then(() => {
          alert('لینک کتاب در کلیپ‌بورد کپی شد.');
        });
      }
    }

    function showLoginModal() {
      alert('سیستم ورود/ثبت‌نام به زودی راه‌اندازی خواهد شد.');
    }

    function updateStats() {
      booksCount.textContent = books.length;
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
